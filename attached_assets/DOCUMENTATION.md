# مستندات کامل ربات فروش اشتراک پریمیوم تلگرام

## فهرست محتوا
1. [مقدمه](#مقدمه)
2. [معماری سیستم](#معماری-سیستم)
3. [ساختار پایگاه داده](#ساختار-پایگاه-داده)
4. [عملکردهای اصلی](#عملکردهای-اصلی)
5. [راه‌اندازی سیستم](#راه‌اندازی-سیستم)
6. [راهنمای استفاده](#راهنمای-استفاده)
7. [مدیریت خطاها](#مدیریت-خطاها)
8. [توسعه آینده](#توسعه-آینده)

## مقدمه

ربات فروش اشتراک پریمیوم تلگرام یک پلتفرم پیشرفته برای مدیریت و فروش اشتراک‌های پریمیوم تلگرام با استفاده از پرداخت ارز دیجیتال است. این سیستم امکان مدیریت کامل فرآیند فروش، از انتخاب پلن تا تأیید پرداخت و فعال‌سازی اشتراک را فراهم می‌کند.

### اهداف اصلی
- ایجاد یک سیستم خودکار برای فروش اشتراک پریمیوم تلگرام
- پشتیبانی از پرداخت با ارز دیجیتال (TRX) از طریق درگاه NowPayments
- ارائه پنل مدیریت برای ادمین‌ها جهت کنترل سفارش‌ها، پلن‌ها و کاربران
- ثبت و نگهداری سوابق تراکنش‌ها و سفارش‌ها

### تکنولوژی‌های مورد استفاده
- **زبان برنامه‌نویسی**: Python 3.8+
- **فریم‌ورک وب**: Flask
- **API تلگرام**: pyTelegramBotAPI
- **پایگاه داده**: PostgreSQL با SQLAlchemy ORM
- **پردازش پرداخت**: NowPayments API

## معماری سیستم

سیستم از یک معماری چند لایه با اجزای زیر تشکیل شده است:

### اجزای اصلی
1. **لایه رابط کاربری تلگرام**: پیاده‌سازی شده در `run_telegram_bot.py`
   - مدیریت دستورات کاربر
   - ارائه منوهای تعاملی با دکمه‌های درون‌خطی
   - پردازش انتخاب‌های کاربر

2. **لایه رابط وب**: پیاده‌سازی شده در `main.py`
   - ارائه رابط مدیریتی تحت وب
   - پردازش وب‌هوک‌های پرداخت
   - نمایش وضعیت سیستم

3. **لایه منطق کسب و کار**: پراکنده در فایل‌های متعدد
   - مدیریت سفارش‌ها و پرداخت‌ها
   - کنترل دسترسی‌ها و اعتبارسنجی‌ها
   - پردازش گردش کارها

4. **لایه دسترسی به داده**: پیاده‌سازی شده در `models.py` و `database.py`
   - تعریف ساختار داده
   - عملیات CRUD روی موجودیت‌ها
   - ارتباط با پایگاه داده

5. **لایه سرویس‌های خارجی**: پیاده‌سازی شده در `nowpayments.py`
   - ارتباط با API های خارجی
   - پردازش پرداخت‌ها
   - دریافت وضعیت تراکنش‌ها

### دیاگرام معماری
```
┌───────────────────┐      ┌───────────────────┐      ┌───────────────────┐
│                   │      │                   │      │                   │
│  Telegram Bot     │◄────►│  Business Logic   │◄────►│  Database Layer   │
│  (run_telegram_bot.py)   │  (handlers.py)    │      │  (models.py)      │
│                   │      │                   │      │                   │
└───────────────────┘      └────────┬──────────┘      └───────────────────┘
                                    │
                                    │
                           ┌────────▼──────────┐      ┌───────────────────┐
                           │                   │      │                   │
                           │  Web Interface    │◄────►│  External Services│
                           │  (main.py)        │      │  (nowpayments.py) │
                           │                   │      │                   │
                           └───────────────────┘      └───────────────────┘
```

## ساختار پایگاه داده

پایگاه داده از سه جدول اصلی تشکیل شده است:

### جدول کاربران (Users)
```
┌────────────────┬────────────────┬─────────────────┐
│ فیلد           │ نوع داده       │ توضیحات         │
├────────────────┼────────────────┼─────────────────┤
│ id             │ Integer        │ کلید اصلی       │
│ telegram_id    │ String(50)     │ شناسه تلگرام    │
│ username       │ String(100)    │ نام کاربری      │
│ first_name     │ String(100)    │ نام             │
│ last_name      │ String(100)    │ نام خانوادگی    │
│ created_at     │ DateTime       │ تاریخ ایجاد     │
│ updated_at     │ DateTime       │ تاریخ به‌روزرسانی│
└────────────────┴────────────────┴─────────────────┘
```

### جدول سفارش‌ها (Orders)
```
┌────────────────┬────────────────┬─────────────────┐
│ فیلد           │ نوع داده       │ توضیحات         │
├────────────────┼────────────────┼─────────────────┤
│ id             │ Integer        │ کلید اصلی       │
│ order_id       │ String(50)     │ شناسه سفارش     │
│ user_id        │ Integer        │ کلید خارجی کاربر│
│ plan_id        │ String(50)     │ شناسه پلن       │
│ plan_name      │ String(100)    │ نام پلن         │
│ amount         │ Float          │ مبلغ            │
│ currency       │ String(10)     │ واحد پول        │
│ status         │ Enum           │ وضعیت سفارش     │
│ telegram_username│ String(100)  │ نام کاربری مقصد │
│ admin_notes    │ Text           │ یادداشت ادمین   │
│ payment_id     │ String(100)    │ شناسه پرداخت    │
│ payment_url    │ String(255)    │ لینک پرداخت     │
│ activation_link│ String(255)    │ لینک فعال‌سازی   │
│ created_at     │ DateTime       │ تاریخ ایجاد     │
│ updated_at     │ DateTime       │ تاریخ به‌روزرسانی│
│ expires_at     │ DateTime       │ تاریخ انقضا      │
└────────────────┴────────────────┴─────────────────┘
```

### جدول تراکنش‌های پرداخت (PaymentTransactions)
```
┌────────────────┬────────────────┬─────────────────┐
│ فیلد           │ نوع داده       │ توضیحات         │
├────────────────┼────────────────┼─────────────────┤
│ id             │ Integer        │ کلید اصلی       │
│ payment_id     │ String(100)    │ شناسه پرداخت    │
│ order_id       │ String(50)     │ کلید خارجی سفارش│
│ amount         │ Float          │ مبلغ            │
│ currency       │ String(10)     │ واحد پول اصلی   │
│ pay_currency   │ String(10)     │ ارز پرداخت     │
│ status         │ String(50)     │ وضعیت پرداخت    │
│ ipn_data       │ JSON           │ داده‌های اعلان   │
│ created_at     │ DateTime       │ تاریخ ایجاد     │
│ updated_at     │ DateTime       │ تاریخ به‌روزرسانی│
│ completed_at   │ DateTime       │ تاریخ تکمیل     │
└────────────────┴────────────────┴─────────────────┘
```

### وضعیت‌های سفارش (OrderStatus)
سفارش‌ها می‌توانند در وضعیت‌های مختلفی قرار بگیرند:
- `PENDING`: در انتظار
- `AWAITING_PAYMENT`: در انتظار پرداخت
- `PAYMENT_RECEIVED`: پرداخت دریافت شده
- `COMPLETED`: تکمیل شده
- `CANCELLED`: لغو شده
- `EXPIRED`: منقضی شده
- `REFUNDED`: بازپرداخت شده
- `ADMIN_REVIEW`: در حال بررسی توسط ادمین
- `APPROVED`: تأیید شده
- `REJECTED`: رد شده

## عملکردهای اصلی

### 1. مدیریت کاربران
- **ثبت کاربر جدید**: هنگام اولین تعامل کاربر با ربات
- **به‌روزرسانی اطلاعات کاربر**: در هر تعامل جدید
- **بازیابی اطلاعات کاربر**: برای نمایش و پردازش سفارش‌ها

### 2. مدیریت پلن‌های اشتراک
- **تعریف پلن‌ها**: در فایل `config.py`
- **ویرایش پلن‌ها**: از طریق پنل ادمین
- **نمایش پلن‌ها**: در منوی اصلی ربات

**ساختار پلن‌ها**:
```python
SUBSCRIPTION_PLANS = [
    {
        "id": "plan_3month",
        "name": "3-Month Premium",
        "description": "دسترسی به امکانات پریمیوم برای 3 ماه",
        "price": 10.99,
        "payment_link": "https://nowpayments.io/payment/?iid=XXXXX"
    },
    {
        "id": "plan_6month",
        "name": "6-Month Premium",
        "description": "دسترسی به امکانات پریمیوم برای 6 ماه",
        "price": 19.99,
        "payment_link": "https://nowpayments.io/payment/?iid=XXXXX"
    },
    {
        "id": "plan_1year",
        "name": "1-Year Premium",
        "description": "دسترسی به امکانات پریمیوم برای 1 سال",
        "price": 34.99,
        "payment_link": "https://nowpayments.io/payment/?iid=XXXXX"
    }
]
```

### 3. فرآیند خرید اشتراک
1. **انتخاب پلن**: کاربر یک پلن را از لیست موجود انتخاب می‌کند
2. **تأیید انتخاب**: کاربر انتخاب خود را تأیید می‌کند
3. **ارائه اطلاعات**: کاربر نام کاربری تلگرام مقصد را وارد می‌کند
4. **دریافت لینک پرداخت**: کاربر لینک پرداخت را دریافت می‌کند
5. **انجام پرداخت**: کاربر از طریق لینک، پرداخت را انجام می‌دهد
6. **تأیید پرداخت**: کاربر پس از پرداخت، دکمه "پرداخت کردم" را می‌زند
7. **بررسی ادمین**: ادمین سفارش را بررسی و تأیید یا رد می‌کند
8. **نتیجه نهایی**: کاربر از نتیجه سفارش مطلع می‌شود

### 4. مدیریت پرداخت‌ها
- **ایجاد تراکنش پرداخت**: هنگام شروع فرآیند پرداخت
- **به‌روزرسانی وضعیت**: پس از دریافت اعلان پرداخت یا بررسی دستی
- **تأیید پرداخت**: توسط ادمین از طریق پنل مدیریت

### 5. پنل ادمین
پنل ادمین از طریق دستور `/admin` در تلگرام قابل دسترسی است و امکانات زیر را فراهم می‌کند:

- **مدیریت سفارش‌ها**:
  - مشاهده فهرست سفارش‌ها
  - جستجوی سفارش‌ها
  - مشاهده جزئیات سفارش
  - تأیید یا رد سفارش‌ها

- **مدیریت پلن‌ها**:
  - ویرایش نام، توضیحات، قیمت و لینک پرداخت پلن‌ها

- **مدیریت پشتیبانی**:
  - تنظیمات چت پشتیبانی
  - تنظیمات پاسخ خودکار

- **مدیریت کانال‌ها**:
  - تنظیم کانال ادمین برای اعلان‌ها
  - تنظیم کانال عمومی برای اعلام خریدها

- **مدیریت ادمین‌ها**:
  - افزودن ادمین جدید
  - حذف ادمین
  - مشاهده فهرست ادمین‌ها

### 6. سیستم اعلان
- **اعلان به ادمین**: هنگام ثبت سفارش جدید یا تغییر وضعیت
- **اعلان به کاربر**: هنگام تأیید یا رد سفارش
- **اعلان عمومی**: اعلام خرید‌های موفق در کانال عمومی (قابل تنظیم)

## راه‌اندازی سیستم

### پیش‌نیازها
- Python 3.8+
- PostgreSQL
- توکن ربات تلگرام (از BotFather)
- کلید API از NowPayments

### مراحل نصب

1. **دریافت کد منبع**:
   ```bash
   git clone https://github.com/asanseir724/telegram-premium-subscription-bot.git
   cd telegram-premium-subscription-bot
   ```

2. **ایجاد محیط مجازی**:
   ```bash
   python -m venv venv
   source venv/bin/activate  # در Windows: venv\Scripts\activate
   ```

3. **نصب وابستگی‌ها**:
   ```bash
   pip install flask flask-sqlalchemy gunicorn pytelegrambotapi python-dotenv psycopg2-binary requests sqlalchemy telebot telegram werkzeug email-validator
   ```

4. **تنظیم متغیرهای محیطی**:
   - کپی فایل `.env.example` به `.env`
   - تکمیل مقادیر متغیرها با مقادیر واقعی:
     ```
     BOT_TOKEN=your_telegram_bot_token
     NOWPAYMENTS_API_KEY=your_nowpayments_api_key
     ADMIN_CHANNEL_ID=your_admin_channel_id
     PUBLIC_CHANNEL_ID=your_public_channel_id
     ADMIN_IDS=admin_id1,admin_id2
     ```

5. **آماده‌سازی پایگاه داده**:
   - ایجاد پایگاه داده PostgreSQL
   - تنظیم متغیرهای دسترسی به پایگاه داده در فایل `.env`

6. **راه‌اندازی سرور**:
   ```bash
   gunicorn --bind 0.0.0.0:5000 --reuse-port --reload main:app
   ```

7. **راه‌اندازی ربات تلگرام** (در یک ترمینال جداگانه):
   ```bash
   python run_telegram_bot.py
   ```

### تنظیمات ربات تلگرام

1. **ایجاد ربات با BotFather**:
   - شروع گفتگو با [@BotFather](https://t.me/BotFather)
   - ارسال دستور `/newbot` و دنبال کردن مراحل
   - کپی توکن دریافتی به فایل `.env`

2. **تنظیم دستورات ربات** (اختیاری):
   - ارسال دستور `/setcommands` به BotFather
   - انتخاب ربات
   - ارسال متن زیر:
     ```
     start - نمایش پلن‌های اشتراک
     plans - مشاهده پلن‌های اشتراک
     help - دریافت راهنمایی
     support - تماس با پشتیبانی
     admin - دسترسی به پنل ادمین (فقط ادمین)
     ```

### تنظیمات NowPayments

1. **ایجاد حساب کاربری** در [NowPayments](https://nowpayments.io)
2. **ایجاد کلید API** و کپی آن به فایل `.env`
3. **ایجاد دکمه‌های پرداخت** برای هر پلن:
   - مراجعه به بخش Payment Buttons در داشبورد NowPayments
   - ایجاد دکمه برای هر پلن (3 ماهه، 6 ماهه، 1 ساله)
   - کپی لینک پرداخت هر دکمه (فرمت: `https://nowpayments.io/payment/?iid=XXXXX`)
   - به‌روزرسانی لینک‌های پرداخت در `config.py`

## راهنمای استفاده

### برای کاربران

1. **شروع کار با ربات**:
   - جستجوی ربات در تلگرام
   - شروع گفتگو با دستور `/start`
   - مشاهده پلن‌های اشتراک

2. **خرید اشتراک**:
   - انتخاب پلن مورد نظر
   - تأیید انتخاب
   - وارد کردن نام کاربری تلگرام برای فعال‌سازی اشتراک
   - دریافت لینک پرداخت
   - انجام پرداخت با ارز دیجیتال TRX
   - کلیک روی دکمه "پرداخت کردم" پس از انجام پرداخت
   - انتظار برای تأیید سفارش توسط پشتیبانی

3. **پیگیری سفارش**:
   - دریافت اعلان وضعیت سفارش پس از بررسی توسط ادمین
   - در صورت تأیید، دریافت لینک فعال‌سازی اشتراک
   - در صورت رد، دریافت پیام توضیحی

### برای ادمین‌ها

1. **دسترسی به پنل ادمین**:
   - ارسال دستور `/admin` به ربات
   - اولین ادمینی که از این دستور استفاده کند، به عنوان سوپر ادمین شناخته می‌شود

2. **مدیریت سفارش‌ها**:
   - انتخاب گزینه "مدیریت سفارش‌ها" از منوی ادمین
   - مشاهده فهرست سفارش‌های در انتظار بررسی
   - انتخاب سفارش برای مشاهده جزئیات
   - تأیید یا رد سفارش با دکمه‌های مربوطه

3. **ویرایش پلن‌ها**:
   - انتخاب گزینه "مدیریت پلن‌ها" از منوی ادمین
   - انتخاب پلن برای ویرایش
   - انتخاب ویژگی مورد نظر (نام، توضیحات، قیمت، لینک پرداخت)
   - وارد کردن مقدار جدید
   - تأیید تغییرات

4. **مدیریت ادمین‌ها** (فقط سوپر ادمین):
   - انتخاب گزینه "مدیریت ادمین‌ها" از منوی ادمین
   - انتخاب "افزودن ادمین" یا "حذف ادمین"
   - وارد کردن شناسه تلگرام ادمین
   - تأیید عملیات

## مدیریت خطاها

### خطاهای رایج و راه‌حل‌ها

1. **عدم پاسخگویی ربات**:
   - بررسی اجرای اسکریپت `run_telegram_bot.py`
   - بررسی صحت توکن ربات
   - بررسی لاگ‌ها برای خطاهای احتمالی

2. **مشکلات پرداخت**:
   - بررسی صحت کلید API نوپیمنتس
   - بررسی تنظیمات وب‌هوک
   - بررسی لاگ‌های پرداخت
   - تست با مبالغ کوچک

3. **مشکلات اتصال به پایگاه داده**:
   - بررسی اعتبار نام کاربری و رمز عبور پایگاه داده
   - بررسی دسترسی‌های کاربر به پایگاه داده
   - بررسی تنظیمات پول ارتباطی

### لاگ‌ها و مانیتورینگ

سیستم لاگینگ در فایل `logger_config.py` پیاده‌سازی شده است و لاگ‌های سیستم در این مسیرها ذخیره می‌شوند:
- لاگ ربات: `logs/telegram_bot.log`
- لاگ وب: `logs/web_app.log`
- لاگ پرداخت: `logs/payment.log`

## توسعه آینده

موارد زیر برای توسعه آینده سیستم پیشنهاد می‌شود:

1. **بهبود سیستم پرداخت**:
   - پشتیبانی از ارزهای دیجیتال بیشتر
   - تأیید خودکار پرداخت با استفاده از وب‌هوک‌ها
   - امکان پرداخت با کارت اعتباری/بانکی

2. **گسترش قابلیت‌های مدیریتی**:
   - داشبورد آماری پیشرفته
   - گزارش‌گیری با فیلترهای مختلف
   - سیستم CRM برای مدیریت ارتباط با مشتری

3. **بهبود رابط کاربری**:
   - اضافه کردن زبان‌های بیشتر
   - شخصی‌سازی بیشتر رابط کاربری
   - اضافه کردن اعلان‌های پیشرفته

4. **امنیت بیشتر**:
   - پیاده‌سازی سیستم احراز هویت دو مرحله‌ای
   - رمزنگاری پیشرفته داده‌ها
   - سیستم تشخیص و پیشگیری از تقلب

5. **مقیاس‌پذیری**:
   - بهینه‌سازی عملکرد برای حجم بالای کاربران
   - معماری میکروسرویس
   - سیستم صف برای پردازش سفارش‌ها

---

*این مستندات تهیه شده در تاریخ 10 آوریل 2025*